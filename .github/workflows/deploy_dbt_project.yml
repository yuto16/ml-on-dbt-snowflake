name: dbt run on Snowflake

on:
  pull_request:
    branches:
      - develop
    paths:
      - 'sample_dbt_project/**' # トリガー条件

env:
  # 変数名をシンプルにして、ステップ内で使いやすくします
  # ※GitHubのSettings > Secrets / Variables に値が設定されている前提です
  SNOWFLAKE_ACCOUNT: ${{ vars.SNOWFLAKE_ACCOUNT }}
  SNOWFLAKE_USER: ${{ vars.SNOWFLAKE_USER }}
  SNOWFLAKE_PAT: ${{ secrets.SNOWFLAKE_PAT }} # パスワード(トークン)は必ずSecretsから
  SNOWFLAKE_ROLE: ${{ vars.SNOWFLAKE_ROLE }}
  SNOWFLAKE_WAREHOUSE: ${{ vars.SNOWFLAKE_WAREHOUSE }}
  SNOWFLAKE_DATABASE: ${{ vars.SNOWFLAKE_DATABASE }}
  SNOWFLAKE_SCHEMA: ${{ vars.SNOWFLAKE_SCHEMA }}
  
  # プロジェクト名 (CI実行ごとにユニークにする)
  DBT_PROJECT_NAME: "ci_dbt_${{ github.event.number }}_${{ github.run_id }}"
  
  # プロジェクトがあるサブディレクトリ名
  PROJECT_DIR: "sample_dbt_project"

jobs:
  dbt-ci:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 公式Actionを使う場合も、単にインストールするだけでOKです
      - name: Install Snowflake CLI
        uses: Snowflake-Labs/snowflake-cli-action@v2.0
        with:
          cli-version: "latest"
          # ここに snow --version 等は書きません

      - name: Check Version
        run: snow --version

      - name: Create Config File
        run: |
          # 「snow connection add」はパスワード入力待ちで止まるため使いません。
          # 直接configファイルを生成するこの方法が最も確実です。
          
          mkdir -p ~/.snowflake

          cat << EOF > ~/.snowflake/config.toml
          default_connection_name = "default"

          [connections.default]
          account = "$SNOWFLAKE_ACCOUNT"
          user = "$SNOWFLAKE_USER"
          password = "$SNOWFLAKE_PAT"
          role = "$SNOWFLAKE_ROLE"
          warehouse = "$SNOWFLAKE_WAREHOUSE"
          database = "$SNOWFLAKE_DATABASE"
          schema = "$SNOWFLAKE_SCHEMA"
          EOF

          chmod 600 ~/.snowflake/config.toml

      - name: Verify Connection
        run: snow connection test

      - name: Deploy dbt Project (Temporary)
        run: |
          echo "Deploying temporary dbt project: $DBT_PROJECT_NAME"
          
          # 【重要】dbtプロジェクトのあるディレクトリへ移動します
          cd "$PROJECT_DIR"
          
          # 【重要】最新CLIに合わせて構文を修正: --project-name は使いません
          # snow dbt deploy <プロジェクト名> --force
          snow dbt deploy "$DBT_PROJECT_NAME" --force

      - name: Run dbt (snow dbt execute)
        run: |
          echo "Executing dbt run on project: $DBT_PROJECT_NAME"
          
          # snow dbt execute <プロジェクト名> <dbtコマンド>
          snow dbt execute "$DBT_PROJECT_NAME" "run"

      - name: Cleanup (Drop Temporary Project)
        if: always()
        run: |
          echo "Dropping temporary dbt project: $DBT_PROJECT_NAME"
          
          # snow dbt drop <プロジェクト名>
          snow dbt drop "$DBT_PROJECT_NAME"