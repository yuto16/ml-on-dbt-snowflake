name: dbt run on Snowflake

on:
  pull_request:
    branches:
      - develop
    paths:
      - 'sample_dbt_project/**' # dbtプロジェクトが含まれるディレクトリを指定（ルートにある場合は不要）

env:
  # Snowflake CLI用の環境変数設定
  # connection "WORKFLOW" を定義します
  SNOWFLAKE_ACCOUNT: ${{ vars.SNOWFLAKE_ACCOUNT }}
  SNOWFLAKE_USER: ${{ vars.SNOWFLAKE_USER }}
  SNOWFLAKE_PAT: ${{ secrets.SNOWFLAKE_PAT }}
  SNOWFLAKE_ROLE: ${{ vars.SNOWFLAKE_ROLE }}
  SNOWFLAKE_WAREHOUSE: ${{ vars.SNOWFLAKE_WAREHOUSE }}
  SNOWFLAKE_DATABASE: ${{ vars.SNOWFLAKE_DATABASE }}
  SNOWFLAKE_SCHEMA: ${{ vars.SNOWFLAKE_SCHEMA }}
  
  # CI実行用の一意なプロジェクト名を生成 (例: my_project_pr_123)
  # 既存のプロジェクトと被らないようにします
  DBT_PROJECT_NAME: "ci_dbt_${{ github.event.number }}_${{ github.run_id }}"

jobs:
  dbt-ci:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Snowflake CLI
        run: |
          pip install snowflake-cli-labs
          snow --version

      - name: Configure Connection
        run: |
          # ここで "default" という名前の接続を明示的に作成します。
          # これにより、以降のコマンドはオプションなしでこの接続を使用します。
          
          snow connection add \
            --connection-name default \
            --account "$SNOWFLAKE_ACCOUNT" \
            --user "$SNOWFLAKE_USER" \
            --password "$SNOWFLAKE_PAT" \
            --role "$SNOWFLAKE_ROLE" \
            --warehouse "$SNOWFLAKE_WAREHOUSE" \
            --database "$SNOWFLAKE_DATABASE" \
            --schema "$SNOWFLAKE_SCHEMA"

      - name: Verify Connection
        run: |
          # 接続確認（PAT認証が通るかテスト）
          snow connection test

      - name: Deploy dbt Project (Temporary)
        run: |
          echo "Deploying temporary dbt project: $DBT_PROJECT_NAME"
          
          # Snowflake上にdbtプロジェクトをデプロイ
          # プロジェクトのディレクトリがルートでない場合はルートへ移動するかパスを指定してください
          # 例: cd dbt_project && snow dbt deploy ...
          
          snow dbt deploy --project-name "$DBT_PROJECT_NAME" --replace

      - name: Run dbt (snow dbt execute)
        run: |
          echo "Executing dbt run on project: $DBT_PROJECT_NAME"
          
          # Snowflake側で 'dbt run' を実行
          # 必要に応じて --args "build" や "--select ..." などを追加可能
          snow dbt execute --project-name "$DBT_PROJECT_NAME" --command "run"

      - name: Cleanup (Drop Temporary Project)
        if: always() # 成功・失敗に関わらず実行してゴミを残さない
        run: |
          echo "Dropping temporary dbt project: $DBT_PROJECT_NAME"
          snow dbt drop --project-name "$DBT_PROJECT_NAME"